name: fakecam
adopt-info: fakecam
summary: Fakecam
description: |
  Fake background removing camera for streaming and video
  conferencing.

  https://elder.dev/posts/open-source-virtual-background/

base: core20
grade: stable
confinement: strict
compression: lzo

architectures:
  - build-on: amd64
  - build-on: arm64
  - build-on: armhf

parts:
  snapcraft-preload:
    source: https://github.com/sergiusens/snapcraft-preload.git
    plugin: cmake
    cmake-parameters:
      - -DCMAKE_INSTALL_PREFIX=/
    build-packages:
      - on amd64:
        - gcc-multilib
        - g++-multilib

  opencv:
    source: https://github.com/opencv/opencv.git
    source-tag: '4.5.1'
    plugin: cmake
    cmake-parameters:
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_opencv_apps=OFF
      - -DBUILD_TESTS=OFF
      - -DBUILD_PERF_TESTS=OFF
      - -DBUILD_opencv_python3=ON
      - -DPYTHON_DEFAULT_EXECUTABLE=/usr/bin/python3
      - -DPYTHON3_EXECUTABLE=/usr/bin/python3
      - -DWITH_FFMPEG=ON
      - -DWITH_GSTREAMER=ON
      - -DWITH_OPENGL=ON
      - -DWITH_VULKAN=ON
      - -DOPENCV_DNN_OPENCL=ON
      - -DENABLE_FAST_MATH=1
      - -DWITH_OPENCL=ON
      - -DWITH_OPENCL_SVM=ON
      - -DWITH_EIGEN=ON
      - -DWITH_LAPACK=ON
      - -DWITH_V4L=ON
      - -DWITH_LIBV4L=ON
      - -DWITH_VA=ON
      - -DWITH_VA_INTEL=ON
      - -DWITH_MFX=ON
      - -DWITH_MKL=ON
      - -DMKL_USE_MULTITHREAD=ON
      - -DMKL_WITH_TBB=ON
      - -DWITH_TBB=ON
      - -DWITH_IPP=ON
      - -DWITH_INF_ENGINE=OFF
    build-snaps:
      - cmake
    build-packages:
      - gfortran
      - libatlas-base-dev
      - libavcodec-dev
      - libavformat-dev
      - libavresample-dev
      - libblas-dev
      - libdc1394-22-dev
      - libeigen3-dev
      - libgflags-dev
      - libglu1-mesa-dev
      - libgoogle-glog-dev
      - libgstreamer-plugins-base1.0-dev
      - libgstreamer1.0-dev
      - libgtk-3-dev
      - libjpeg-dev
      - liblapack-dev
      - libopenblas-dev
      - libopenexr-dev
      - libopenjp2-7-dev
      - libopenjp2-tools
      - libopenjpip-dec-server
      - libopenjpip-server
      - libpng-dev
      - libprotobuf-dev
      - libswscale-dev
      - libtbb-dev
      - libtiff-dev
      - libv4l-dev
      - libva-dev
      - libvulkan-dev
      - libwebp-dev
      - linux-libc-dev
      - ocl-icd-opencl-dev
      - python3-dev
      - python3-numpy
    stage-packages:
      - libatlas3-base
      - libavcodec57
      - libavformat57
      - libavresample3
      - libblas3
      - libdc1394-22
      - libgflags2.2
      - libglu1-mesa
      - libgoogle-glog0v5
      - libgstreamer-plugins-base1.0-0
      - libgstreamer1.0-0
      - libjpeg8
      - liblapack3
      - libopenblas-base
      - libopenexr22
      - libopenjp2-tools
      - libopenjpip7
      - libopenjpip-dec-server
      - libopenjpip-server
      - libpng16-16
      - libprotobuf10
      - libswscale4
      - libtbb2
      - libtiff5
      - libv4l-0
      - libva2
      - libvulkan1
      - libwebp6
      - mesa-opencl-icd
      - va-driver-all
    stage:
      - -usr/bin/python3

  fakecam:
    after: [opencv]
    source: src
    plugin: python
    requirements: [requirements.txt]
    build-environment:
      - PATH: /usr/bin:$PATH
      - PYTHONPATH: ''
    override-build: |
      snapcraftctl build
      snapcraftctl set-version $(python3 fakecam/about.py)
    build-packages:
      - libgirepository1.0-dev
    stage-packages:
      - freeglut3
      - gir1.2-glib-2.0
      - gir1.2-gst-plugins-base-1.0
      - gir1.2-gstreamer-1.0
      - gir1.2-gtk-3.0
      - gobject-introspection
      - gstreamer1.0-gtk3
      - gstreamer1.0-plugins-good
      - libgirepository-1.0-1
      - libglu1-mesa
      - libgpm2
      - libice6
      - libpulse-mainloop-glib0
      - libslang2
      - libsm6
      - libx11-6
      - libxext6
      - libxkbcommon-x11-0
      - libxrender1
      - python3-gi

  fclaunch:
    source: .
    plugin: nil
    override-pull: |
      cat <<'EOF' > fclaunch
      #!/bin/bash
      # export LD_LIBRARY_PATH="/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:/usr/lib:/lib/$SNAPCRAFT_ARCH_TRIPLET:/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}:$SNAP/opencv/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/opencv/usr/lib:$SNAP/opencv/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/opencv/usr/lib:$SNAP/opencv/usr/local/cuda-11.2/lib64"
      export LD_LIBRARY_PATH="$(ls -d $SNAP/opencv/usr/local/cuda-* | tail -n1)/lib64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
      exec "$@"
      EOF
    override-build: |
      install -m755 -D -t $SNAPCRAFT_PART_INSTALL/bin fclaunch

  cleanup:
    after: [fakecam]
    plugin: nil
    build-snaps: [core20, gtk-common-themes, gnome-3-38-2004]
    override-prime: |
      set -eux
      for snap in "core20" "gtk-common-themes" "gnome-3-38-2004"; do
        cd "/snap/$snap/current"
        [ -d "lib" ] && find ./lib -type f,l -exec rm -f "$SNAPCRAFT_PRIME/lib/{}" "$SNAPCRAFT_PRIME/usr/lib/{}" \;
        [ -d "share" ] && find ./share -type f,l -exec rm -f "$SNAPCRAFT_PRIME/share/{}" "$SNAPCRAFT_PRIME/usr/share/{}" \;
        [ -d "usr/lib" ] && find ./usr/lib -type f,l -exec rm -f "$SNAPCRAFT_PRIME/lib/{}" "$SNAPCRAFT_PRIME/usr/lib/{}" \;
        [ -d "usr/share" ] && find ./usr/share -type f,l -exec rm -f "$SNAPCRAFT_PRIME/share/{}" "$SNAPCRAFT_PRIME/usr/share/{}" \;
      done
      for CRUFT in bug lintian man; do
        rm -rf $SNAPCRAFT_PRIME/usr/share/$CRUFT
      done
      find $SNAPCRAFT_PRIME/usr/share/doc/ -type f -not -name 'copyright' -delete
      find $SNAPCRAFT_PRIME/usr/share -type d -empty -delete

layout:
  /etc/OpenCL:
    bind: $SNAP/etc/OpenCL
  /usr/include/clc:
    bind: $SNAP/usr/include/clc
  /usr/lib/clc:
    bind: $SNAP/usr/lib/clc
  /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gallium-pipe:
    bind: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gallium-pipe
  /usr/share/libdrm/amdgpu.ids:
    bind-file: $SNAP/usr/share/libdrm/amdgpu.ids
  /opt/intel:
    bind: $SNAP/opt/intel

environment:
  LD_LIBRARY_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib:$SNAP/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/lib
  PYTHONPATH: $SNAP/usr/lib/python3.8/dist-packages:$SNAP/usr/lib/python3/dist-packages:$SNAP/usr/lib/python3.8/dist-packages:$SNAP/usr/lib/python3/dist-packages

apps:
  clinfo:
    command: bin/fclaunch $SNAP/usr/bin/clinfo
    extensions: [gnome-3-38]
    plugs:
      - camera
      - desktop
      - home
      - network
      - network-bind
      - opengl
      - removable-media
      - wayland
      - x11

  fakecam:
    command: bin/fclaunch $SNAP/bin/fakecamcli
    extensions: [gnome-3-38]
    plugs:
      - camera
      - desktop
      - home
      - network
      - network-bind
      - opengl
      - removable-media
      - wayland
      - x11

  gui:
    command: bin/fclaunch $SNAP/bin/fakecamgui
    command-chain:
      - bin/snapcraft-preload
    extensions: [gnome-3-38]
    plugs:
      - camera
      - desktop
      - home
      - network
      - network-bind
      - opengl
      - removable-media
      - wayland
      - x11
